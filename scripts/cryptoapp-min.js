let cryptoDataContainer=document.getElementById("crypto-data");const searchInput=document.getElementById("search"),modal=document.getElementById("price-alert-modal"),closeButton=document.querySelector(".close-button"),setCryptocurrencyPriceAlertButton=document.getElementById("set-alert-button");let currentCoinId=null;const toggleThemeButton=document.getElementById("toggle-theme"),loadingSpinner=document.getElementById("loading-spinner"),errorMessage=document.createElement("div");errorMessage.className="error-message",cryptoDataContainer.appendChild(errorMessage);let darkMode=JSON.parse(localStorage.getItem("darkMode"))||!1;const favorites=JSON.parse(localStorage.getItem("favorites"))||[];let latestCryptoData=[];function debounce(e,t){let a;return function(...n){clearTimeout(a),a=setTimeout((()=>e.apply(this,n)),t)}}async function fetchCryptoPrices(){loadingSpinner.style.display="block",errorMessage.textContent="",cryptoDataContainer.innerHTML="";try{const e=await fetch("https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=20&page=1&sparkline=false");if(!e.ok)throw new Error("Failed to fetch data from the server.");const t=await e.json();latestCryptoData=t,populateCryptoData(t)}catch(e){errorMessage.textContent="Error loading data. Please try again later."}finally{loadingSpinner.style.display="none"}}function populateCryptoData(e){cryptoDataContainer.innerHTML="";const t=localStorage.getItem("selectedLanguage")||"en",a=translations[t]||translations.en;[...e.filter((e=>favorites.includes(e.id))),...e.filter((e=>!favorites.includes(e.id)))].forEach((e=>{const t=document.createElement("div");t.className="crypto-card",t.dataset.id=e.id;const n=e.price_change_percentage_24h>=0?'<svg width="14" height="14" fill="green"><polygon points="7,0 14,14 0,14" /></svg>':'<svg width="14" height="14" fill="red"><polygon points="7,14 14,0 0,0" /></svg>';t.innerHTML=`\n      <h2>${e.name} (${e.symbol.toUpperCase()})</h2>\n      <p class="current-price">Price: ${e.current_price.toFixed(2)} USD ${n}</p>\n      <p class="market-cap">${a.labels.marketCap}: ${e.market_cap.toLocaleString()} USD</p>\n      <p class="price-change">${a.labels.change}: ${e.price_change_percentage_24h.toFixed(2)}%</p>\n      <button class="favorite-button" data-tooltip="${favorites.includes(e.id)?a.buttons.favoriteTooltipRemove.replace("{coinName}",e.name):a.buttons.favoriteTooltipAdd.replace("{coinName}",e.name)}">${favorites.includes(e.id)?a.buttons.removeFromFavorites:a.buttons.addToFavorites}</button>\n      <button class="alert-button" data-tooltip="${a.buttons.alertTooltip.replace("{coinName}",e.name)}">${a.buttons.setPriceAlert}</button>\n    `,cryptoDataContainer.appendChild(t),t.querySelector(".favorite-button").addEventListener("click",(()=>{toggleFavorite(e.id)})),t.querySelector(".alert-button").addEventListener("click",(()=>{setPriceAlert(e.id)}))})),updateFavoritesDisplay()}function toggleFavorite(e){favorites.includes(e)?favorites.splice(favorites.indexOf(e),1):favorites.push(e),localStorage.setItem("favorites",JSON.stringify(favorites)),updateCryptoDisplay(document.getElementById("filter-select").value,document.getElementById("sort-select").value),updateFavoritesDisplay()}function updateFavoritesDisplay(){const e=cryptoDataContainer.getElementsByClassName("crypto-card");for(let t of e){const e=t.dataset.id;favorites.includes(e)?(t.classList.add("favorite"),t.querySelector(".favorite-button").classList.add("favorite")):(t.classList.remove("favorite"),t.querySelector(".favorite-button").classList.remove("favorite"))}}function saveFavoritesOrder(e){for(localStorage.setItem("favorites",JSON.stringify(e));favorites.length;)favorites.pop();e.forEach((e=>favorites.push(e)))}function loadFavoritesOrder(){return JSON.parse(localStorage.getItem("favorites"))||[]}const debouncedSearch=debounce((()=>{const e=searchInput.value.toLowerCase(),t=cryptoDataContainer.getElementsByClassName("crypto-card");for(let a of t){const t=a.querySelector("h2").textContent.toLowerCase();a.style.display=t.includes(e)?"":"none"}}),300);function updateCryptoDisplay(e,t){if(!Array.isArray(latestCryptoData)||0===latestCryptoData.length)return;let a=[...latestCryptoData];"favorites"===e&&(a=a.filter((e=>favorites.includes(e.id)))),"marketCap"===t?a.sort(((e,t)=>(t.market_cap||0)-(e.market_cap||0))):"priceChange"===t&&a.sort(((e,t)=>(t.price_change_percentage_24h||0)-(e.price_change_percentage_24h||0))),cryptoDataContainer.innerHTML="",populateCryptoData(a)}function setPriceAlert(e){currentCoinId=e,modal.style.display="block"}document.body.classList.toggle("dark-mode",darkMode),toggleThemeButton.innerHTML='<i class="fas fa-adjust"></i> '+(darkMode?"Dark Theme":"Light Theme"),searchInput.addEventListener("input",debouncedSearch),toggleThemeButton.addEventListener("click",(()=>{darkMode=!darkMode,document.body.classList.toggle("dark-mode",darkMode),localStorage.setItem("darkMode",JSON.stringify(darkMode));const e=document.getElementById("language-selector").value;toggleThemeButton.innerHTML=`<i class="fas fa-adjust"></i> ${darkMode?translations[e].controls.darkTheme:translations[e].controls.lightTheme}`})),document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("filter-select"),t=document.getElementById("sort-select");e.addEventListener("change",(()=>{updateCryptoDisplay(e.value,t.value)})),t.addEventListener("change",(()=>{updateCryptoDisplay(e.value,t.value)}))})),closeButton.addEventListener("click",(()=>{modal.style.display="none"}));const setPriceAlertAction=()=>{const e=parseFloat(document.getElementById("alert-price").value),t=localStorage.getItem("selectedLanguage")||"en",a=translations[t]||translations.en;if(isNaN(e))alert(a.errorMessages.invalidPrice);else{const t=JSON.parse(localStorage.getItem("priceAlerts"))||{};t[currentCoinId]=e,localStorage.setItem("priceAlerts",JSON.stringify(t));const n=document.querySelector(`.crypto-card[data-id="${currentCoinId}"] h2`).textContent.split(" ")[0];alert(a.alerts.priceAlertSet.replace("{price}",e).replace("{coinName}",n)),modal.style.display="none"}};function capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}function checkPriceAlerts(){const e=JSON.parse(localStorage.getItem("priceAlerts"))||{},t=cryptoDataContainer.getElementsByClassName("crypto-card");for(let a of t){const t=a.dataset.id,n=parseFloat(a.querySelector("p").textContent.match(/[\d.]+/)[0]);if(e[t]){n>=e[t]&&(alert(`Price alert! ${capitalizeFirstLetter(t)} has reached ${n} USD.`),delete e[t])}}localStorage.setItem("priceAlerts",JSON.stringify(e))}setCryptocurrencyPriceAlertButton.addEventListener("click",(()=>setPriceAlertAction())),document.getElementById("alert-price").addEventListener("keydown",(e=>{"Enter"===e.key&&setPriceAlertAction()}));const newsSectionContainer=document.createElement("div");newsSectionContainer.id="news-section";const newsHeading=document.createElement("h2");newsHeading.textContent="Latest Cryptocurrency News";const articlesContainer=document.createElement("div");async function fetchCryptoNews(){try{const e=await fetch("https://cointelegraph.com/rss");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.text(),a=new DOMParser,n=a.parseFromString(t,"text/xml").getElementsByTagName("item");displayNewsArticles(Array.from(n).slice(0,30).map((e=>({title:e.getElementsByTagName("title")[0].textContent,description:e.getElementsByTagName("description")[0].textContent,url:e.getElementsByTagName("link")[0].textContent,publishedAt:e.getElementsByTagName("pubDate")[0].textContent}))))}catch(e){newsSectionContainer.innerHTML="<p>Error loading news. Please try again later.</p>"}}function displayNewsArticles(e){const t=document.getElementById("news-articles");t.innerHTML="",e.forEach((e=>{const a=document.createElement("div");a.className="news-article",a.innerHTML=`\n      <h3><a href="${e.url}" target="_blank">${e.title}</a></h3>\n      <p>${e.description}</p>\n      <p><small>Published on: ${new Date(e.publishedAt).toLocaleDateString()}</small></p>\n    `,t.appendChild(a)}))}articlesContainer.id="news-articles",newsSectionContainer.appendChild(newsHeading),newsSectionContainer.appendChild(articlesContainer),document.body.appendChild(newsSectionContainer);let currentLanguage=localStorage.getItem("selectedLanguage")||"en";document.getElementById("language-selector").addEventListener("change",(e=>{const t=e.target.value;document.getElementById("language-selector").value=t,localStorage.setItem("selectedLanguage",t),updateText(t)})),document.addEventListener("DOMContentLoaded",(()=>{document.getElementById("language-selector").value=currentLanguage,updateText(currentLanguage),fetchCryptoPrices().then((()=>{fetchCryptoNews()})).catch((e=>{})),setInterval((()=>{fetchCryptoPrices().then((()=>{fetchCryptoNews()})).catch((e=>{}))}),6e4),setInterval(checkPriceAlerts,6e4)}));
